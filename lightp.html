<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js 球谐环境光照演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e6e6e6;
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem 2rem;
            border-bottom: 1px solid #00a8ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, #00a8ff, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            color: #a0aec0;
            margin-top: 0.3rem;
        }
        
        .description {
            max-width: 600px;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            color: #cbd5e0;
        }
        
        .controls-container {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
        }
        
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            outline: none;
        }
        
        .gui-container {
            width: 320px;
            background: rgba(15, 23, 42, 0.85);
            border-left: 1px solid #2d3748;
            padding: 15px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        
        .panel-title {
            font-size: 1.2rem;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #00a8ff;
            color: #63b3ed;
            display: flex;
            align-items: center;
        }
        
        .panel-title i {
            margin-right: 10px;
            font-size: 1.3rem;
        }
        
        .sh-coefficients {
            background: rgba(26, 32, 44, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            overflow: auto;
            max-height: 200px;
        }
        
        .sh-coefficients pre {
            color: #81e6d9;
            line-height: 1.4;
        }
        
        .info-box {
            background: rgba(26, 32, 44, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
        }
        
        .info-box h3 {
            color: #63b3ed;
            margin-bottom: 10px;
        }
        
        .info-box ul {
            padding-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 8px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .color-box {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border-top: 1px solid #2d3748;
            font-size: 0.85rem;
            color: #a0aec0;
        }
        
        @media (max-width: 768px) {
            .controls-container {
                flex-direction: column;
            }
            
            .gui-container {
                width: 100%;
                height: 300px;
                border-left: none;
                border-top: 1px solid #2d3748;
            }
            
            header {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Three.js 球谐环境光照演示</h1>
                <div class="subtitle">使用27个浮点数数组创建环境光照</div>
            </div>
            <div class="description">
                球谐光照是一种高性能的环境光技术，使用27个浮点数(9个RGB向量)表示环境光分布
            </div>
        </header>
        
        <div class="controls-container">
            <div id="canvas-container">
                <canvas id="three-canvas"></canvas>
            </div>
            
            <div class="gui-container">
                <div class="panel-title">
                    <span>⚙️ 光照控制面板</span>
                </div>
                
                <div class="sh-coefficients">
                    <pre>球谐系数数据 (27个浮点数):
  [
    // L0, M0
    <span style="color:#80ffea">0.5</span>, <span style="color:#80ff80">0.6</span>, <span style="color:#80b3ff">0.7</span>,  
    
    // L1, M-1 ~ M1
    <span style="color:#80ffea">0.1</span>, <span style="color:#80ff80">0.2</span>, <span style="color:#80b3ff">0.3</span>,
    <span style="color:#80ffea">-0.2</span>, <span style="color:#80ff80">-0.3</span>, <span style="color:#80b3ff">-0.4</span>,
    <span style="color:#80ffea">0.3</span>, <span style="color:#80ff80">0.4</span>, <span style="color:#80b3ff">0.5</span>,
    
    // L2, M-2 ~ M2
    <span style="color:#80ffea">-0.1</span>, <span style="color:#80ff80">-0.2</span>, <span style="color:#80b3ff">-0.3</span>,
    <span style="color:#80ffea">0.4</span>, <span style="color:#80ff80">0.5</span>, <span style="color:#80b3ff">0.6</span>,
    <span style="color:#80ffea">-0.5</span>, <span style="color:#80ff80">-0.6</span>, <span style="color:#80b3ff">-0.7</span>,
    <span style="color:#80ffea">0.2</span>, <span style="color:#80ff80">0.3</span>, <span style="color:#80b3ff">0.4</span>,
    <span style="color:#80ffea">0.0</span>, <span style="color:#80ff80">0.1</span>, <span style="color:#80b3ff">0.2</span>
  ]</pre>
                </div>
                
                <div id="gui"></div>
                
                <div class="info-box">
                    <h3>球谐光照说明</h3>
                    <ul>
                        <li>使用低阶球谐函数(3阶)近似环境光照</li>
                        <li>只需27个浮点数(9个RGB向量)</li>
                        <li>非常适合移动端和性能敏感场景</li>
                        <li>提供柔和的全局环境光照效果</li>
                        <li>动态更新光照无性能开销</li>
                    </ul>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="color-box" style="background-color: #80ffea;"></div>
                            <span>红色分量</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color: #80ff80;"></div>
                            <span>绿色分量</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color: #80b3ff;"></div>
                            <span>蓝色分量</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            使用 Three.js 实现的球谐环境光照演示 | 球谐光照系数可实时调整
        </footer>
    </div>

    <!-- 引入Three.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.16.1/dist/lil-gui.umd.min.js"></script>
    
    <script>
        // 主Three.js场景初始化
        function init() {
            // 创建场景
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0c0c1a);
            scene.fog = new THREE.Fog(0x0c0c1a, 20, 50);

            // 创建相机
            const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 16);
            camera.lookAt(0, 0, 0);

            // 创建渲染器
            const renderer = new THREE.WebGLRenderer({
                canvas: document.getElementById('three-canvas'),
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;

            // 添加轨道控制器
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // ====================
            // 球谐环境光照设置
            // ====================
            // 27个浮点数的球谐数据
            const shCoefficients = [
                // L0, M0 (1个系数)
                0.5, 0.6, 0.7,   // RGB 分量
                
                // L1, M-1 ~ M1 (3个系数)
                0.1, 0.2, 0.3,
                -0.2, -0.3, -0.4,
                0.3, 0.4, 0.5,
                
                // L2, M-2 ~ M2 (5个系数)
                -0.1, -0.2, -0.3,
                0.4, 0.5, 0.6,
                -0.5, -0.6, -0.7,
                0.2, 0.3, 0.4,
                0.0, 0.1, 0.2
            ];

            // 创建球谐光照
            const sh = new THREE.SphericalHarmonics3();
            const coefficients = [];

            // 将27个浮点数转换为9个Vector3
            for (let i = 0; i < 9; i++) {
                const index = i * 3;
                coefficients.push(new THREE.Vector3(
                    shCoefficients[index],
                    shCoefficients[index + 1],
                    shCoefficients[index + 2]
                ));
            }

            sh.coefficients = coefficients;

            // 创建LightProbe并设置球谐数据
            const lightProbe = new THREE.LightProbe();
            lightProbe.sh = sh;
            lightProbe.intensity = 1.5;
            scene.add(lightProbe);

            // ====================
            // 场景物体设置
            // ====================
            // 创建各种几何体材质
            const materials = [
                new THREE.MeshStandardMaterial({ 
                    color: 0xff4d4d, 
                    roughness: 0.1, 
                    metalness: 0.9 
                }),
                new THREE.MeshStandardMaterial({ 
                    color: 0x4dff4d, 
                    roughness: 0.3, 
                    metalness: 0.5 
                }),
                new THREE.MeshStandardMaterial({ 
                    color: 0x4d4dff, 
                    roughness: 0.5, 
                    metalness: 0.3 
                }),
                new THREE.MeshStandardMaterial({ 
                    color: 0xffd700, 
                    roughness: 0.2, 
                    metalness: 0.7 
                }),
                new THREE.MeshStandardMaterial({ 
                    color: 0xff69b4, 
                    roughness: 0.4, 
                    metalness: 0.4 
                })
            ];

            // 创建几何体
            const geometries = [
                new THREE.TorusKnotGeometry(1, 0.4, 100, 32),
                new THREE.IcosahedronGeometry(1, 1),
                new THREE.ConeGeometry(1, 2, 32),
                new THREE.OctahedronGeometry(1.2, 1)
            ];

            // 创建多个物体
            const objects = [];
            const gridSize = 3;
            const spacing = 4;
            
            for (let x = 0; x < gridSize; x++) {
                for (let z = 0; z < gridSize; z++) {
                    const idx = (x * gridSize + z) % geometries.length;
                    const mesh = new THREE.Mesh(geometries[idx], materials[idx]);
                    
                    mesh.position.set(
                        (x - (gridSize - 1) / 2) * spacing,
                        1.5,
                        (z - (gridSize - 1) / 2) * spacing
                    );
                    
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData.originalY = mesh.position.y;
                    
                    scene.add(mesh);
                    objects.push(mesh);
                }
            }

            // 添加地面
            const groundGeometry = new THREE.PlaneGeometry(30, 30);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1e293b,
                roughness: 0.8,
                metalness: 0.2
            });
            
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.receiveShadow = true;
            scene.add(ground);

            // 添加装饰性网格
            const gridHelper = new THREE.GridHelper(30, 20, 0x4a5568, 0x2d3748);
            gridHelper.position.y = -1.99;
            scene.add(gridHelper);

            // ====================
            // GUI控制面板
            // ====================
            const gui = new lil.GUI({ autoPlace: false, container: document.getElementById('gui') });
            gui.width = 280;
            
            // 光照强度控制
            const lightFolder = gui.addFolder('光照设置');
            lightFolder.add(lightProbe, 'intensity', 0, 5, 0.1).name('光照强度');
            
            // 球谐系数控制
            const shCoeffs = sh.coefficients.map((v, i) => ({
                index: i,
                x: v.x,
                y: v.y,
                z: v.z
            }));
            
            const coeffFolder = gui.addFolder('球谐系数');
            
            shCoeffs.forEach(coeff => {
                const folder = coeffFolder.addFolder(`系数 ${coeff.index}`);
                folder.add(coeff, 'x', -1, 1, 0.01).name('红色分量').onChange(updateCoefficients);
                folder.add(coeff, 'y', -1, 1, 0.01).name('绿色分量').onChange(updateCoefficients);
                folder.add(coeff, 'z', -1, 1, 0.01).name('蓝色分量').onChange(updateCoefficients);
            });
            
            coeffFolder.open();
            
            function updateCoefficients() {
                // 更新球谐系数
                shCoeffs.forEach((coeff, index) => {
                    sh.coefficients[index].set(coeff.x, coeff.y, coeff.z);
                });
                
                // 需要标记为更新
                lightProbe.sh = sh;
            }
            
            // 场景控制
            const sceneFolder = gui.addFolder('场景控制');
            sceneFolder.add({ rotationSpeed: 0.5 }, 'rotationSpeed', 0, 2, 0.1).name('旋转速度');
            sceneFolder.add({ bounce: true }, 'bounce').name('物体浮动');
            sceneFolder.open();
            
            lightFolder.open();
            gui.close();

            // ====================
            // 动画循环
            // ====================
            let time = 0;
            
            function animate() {
                requestAnimationFrame(animate);
                
                time += 0.01;
                
                // 物体浮动动画
                /*
                objects.forEach((obj, idx) => {
                    obj.rotation.y = time * (0.5 + idx * 0.05);
                    obj.rotation.x = Math.sin(time * 0.5 + idx) * 0.2;
                    
                    if (sceneFolder.__controllers[1].getValue()) {
                        obj.position.y = obj.userData.originalY + Math.sin(time * 2 + idx) * 0.5;
                    }
                });*/
                
                controls.update();
                renderer.render(scene, camera);
            }
            
            // 窗口大小调整处理
            function handleResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            window.addEventListener('resize', handleResize);
            
            // 启动动画
            animate();
        }

        // 初始化场景
        window.addEventListener('load', init);
    </script>
</body>
</html>